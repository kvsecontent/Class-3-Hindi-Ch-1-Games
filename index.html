// Game Data
const matchingPairs = [
    { id: 1, front: "फूलों से", back: "हँसना सीखो" },
    { id: 2, front: "भौंरों से", back: "गाना सीखो" },
    { id: 3, front: "तरु की झुकी डालियों से", back: "शीश झुकाना सीखो" },
    { id: 4, front: "हवा के झोंकों से", back: "कोमल भाव बहाना सीखो" },
    { id: 5, front: "दूध तथा पानी से", back: "मिलना और मिलाना सीखो" },
    { id: 6, front: "सूरज की किरणों से", back: "जगना और जगाना सीखो" },
    { id: 7, front: "लता और पेड़ों से", back: "सबको गले लगाना सीखो" },
    { id: 8, front: "दीपक से", back: "अंधेरा दूर करना सीखो" }
];

const wordSearchWords = [
    "फूल", "भौंरा", "सूरज", "दीपक", "पृथ्वी", "जलधारा", "धुएँ", "पेड़", "पानी", "सीखो", "किरण"
];

const quizQuestions = [
    {
        question: "कविता में 'फूलों से' क्या सीखने की बात कही गई है?",
        options: ["रोना", "हँसना", "सोना", "दौड़ना"],
        answer: 1
    },
    {
        question: "सूरज की किरणों से हमें क्या सीखना चाहिए?",
        options: ["अंधेरा करना", "जगना और जगाना", "छुपना", "चुप रहना"],
        answer: 1
    },
    {
        question: "दीपक से हमें क्या सीखना चाहिए?",
        options: ["जलना", "अंधेरा दूर करना", "प्रकाश देना", "तेल बचाना"],
        answer: 1
    },
    {
        question: "पृथ्वी से हमें क्या सीखने की बात कही गई है?",
        options: ["धैर्य रखना", "प्राणी की सच्ची सेवा करना", "गर्मी सहना", "चुप रहना"],
        answer: 1
    },
    {
        question: "लता और पेड़ों से हमें क्या सीखना चाहिए?",
        options: ["फल देना", "सबको गले लगाना", "छाया देना", "हरा रहना"],
        answer: 1
    },
    {
        question: "जलधारा से हमें क्या सीखना चाहिए?",
        options: ["आगे बढ़ना", "बहना", "तैरना", "शांत रहना"],
        answer: 0
    },
    {
        question: "कविता का मुख्य संदेश क्या है?",
        options: ["प्रकृति से सीखना", "पेड़ लगाना", "पानी बचाना", "खेलना"],
        answer: 0
    },
    {
        question: "तरु की झुकी डालियों से हमें क्या सीखना चाहिए?",
        options: ["नमस्कार करना", "शीश झुकाना", "फल देना", "विनम्र रहना"],
        answer: 1
    },
    {
        question: "हवा के झोंकों से हम क्या सीखते हैं?",
        options: ["तेज चलना", "गरम होना", "कोमल भाव बहाना", "ठंडा होना"],
        answer: 2
    },
    {
        question: "दूध तथा पानी से हमें क्या सीखना चाहिए?",
        options: ["पीना", "मिलना और मिलाना", "बहना", "नहाना"],
        answer: 1
    }
];

// Game Variables
let playerName = "";
let playerClass = "";
let currentGame = "";
let matchingScore = 0;
let wordScore = 0;
let quizScore = 0;
let totalScore = 0;

let selectedCards = [];
let matchedPairs = 0;

let currentWordSelection = [];
let foundWords = [];

let currentQuestionIndex = 0;
let gamesInitialized = false;

// DOM Elements
let loginPage, gameMenu, gameScreens, gameOverScreen;
let startButton, gameOptions, backButtons, playAgainButton, hintButtons;
let playerNameDisplay, matchingScoreDisplay, wordScoreDisplay, quizScoreDisplay, totalScoreDisplay;

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    // Initialize DOM elements
    loginPage = document.querySelector('.login-page');
    gameMenu = document.querySelector('.game-menu');
    gameScreens = document.querySelectorAll('.game-screen');
    gameOverScreen = document.querySelector('.game-over');
    
    startButton = document.getElementById('start-button');
    gameOptions = document.querySelectorAll('.game-option');
    backButtons = document.querySelectorAll('.back-button');
    playAgainButton = document.getElementById('play-again');
    hintButtons = document.querySelectorAll('.hint-button');
    
    playerNameDisplay = document.getElementById('player-name');
    matchingScoreDisplay = document.getElementById('matching-score');
    wordScoreDisplay = document.getElementById('word-score');
    quizScoreDisplay = document.getElementById('quiz-score');
    totalScoreDisplay = document.getElementById('total-score');
    
    // Start Game
    if (startButton) {
        startButton.addEventListener('click', startGame);
    }
    
    // Game Selection
    gameOptions.forEach(option => {
        option.addEventListener('click', selectGame);
    });
    
    // Back to Menu
    backButtons.forEach(button => {
        button.addEventListener('click', goBackToMenu);
    });
    
    // Play Again
    if (playAgainButton) {
        playAgainButton.addEventListener('click', resetAllGames);
    }
    
    // Hint Buttons
    hintButtons.forEach(button => {
        button.addEventListener('click', showHint);
    });
});

// Game Functions
function startGame() {
    try {
        const nameInput = document.getElementById('student-name');
        const classInput = document.getElementById('student-class');
        
        if (!nameInput || !classInput) {
            console.error("Name or class input not found");
            return;
        }
        
        if (nameInput.value.trim() === "") {
            alert("कृपया अपना नाम दर्ज करें!");
            return;
        }
        
        if (classInput.value === "") {
            alert("कृपया अपनी कक्षा चुनें!");
            return;
        }
        
        playerName = nameInput.value.trim();
        playerClass = classInput.value;
        
        if (playerNameDisplay) {
            playerNameDisplay.textContent = playerName;
        }
        
        loginPage.classList.remove('active');
        gameMenu.classList.add('active');
        
        // Initialize games once when user starts
        if (!gamesInitialized) {
            preloadGames();
            gamesInitialized = true;
        }
    } catch (error) {
        console.error("Error in startGame:", error);
    }
}

function preloadGames() {
    try {
        // Preload game assets but don't run full initialization yet
        console.log("Preloading game assets...");
    } catch (error) {
        console.error("Error in preloadGames:", error);
    }
}

function selectGame(event) {
    try {
        const selectedGame = event.currentTarget.dataset.game;
        currentGame = selectedGame;
        
        gameMenu.classList.remove('active');
        
        const gameScreen = document.querySelector(`.${selectedGame}-game`);
        if (!gameScreen) {
            console.error(`Game screen for ${selectedGame} not found`);
            return;
        }
        
        gameScreen.classList.add('active');
        
        // Initialize the specific game when selected
        if (selectedGame === 'matching') {
            initializeMatchingGame();
            resetMatchingGame();
        } else if (selectedGame === 'word') {
            initializeWordSearch();
            resetWordSearch();
        } else if (selectedGame === 'quiz') {
            resetQuiz();
            displayQuestion();
        }
    } catch (error) {
        console.error("Error in selectGame:", error);
    }
}

function goBackToMenu() {
    try {
        // Hide all game screens
        gameScreens.forEach(screen => {
            screen.classList.remove('active');
        });
        
        // Show the menu
        gameMenu.classList.add('active');
    } catch (error) {
        console.error("Error in goBackToMenu:", error);
    }
}

function showHint(event) {
    try {
        const hintText = event.currentTarget.nextElementSibling;
        if (hintText) {
            hintText.style.display = hintText.style.display === 'block' ? 'none' : 'block';
        }
    } catch (error) {
        console.error("Error in showHint:", error);
    }
}

function updateTotalScore() {
    try {
        totalScore = matchingScore + wordScore + quizScore;
        if (totalScoreDisplay) {
            totalScoreDisplay.textContent = totalScore;
        }
    } catch (error) {
        console.error("Error in updateTotalScore:", error);
    }
}

function checkGameCompletion() {
    try {
        if (matchedPairs === matchingPairs.length / 2 && foundWords.length === wordSearchWords.length && currentQuestionIndex >= quizQuestions.length) {
            // All games completed
            gameScreens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            updateTotalScore();
            createConfetti();
            
            if (gameOverScreen) {
                gameOverScreen.classList.add('active');
            }
        }
    } catch (error) {
        console.error("Error in checkGameCompletion:", error);
    }
}

function resetAllGames() {
    try {
        resetMatchingGame();
        resetWordSearch();
        resetQuiz();
        
        totalScore = 0;
        updateTotalScore();
        
        if (gameOverScreen) {
            gameOverScreen.classList.remove('active');
        }
        
        gameMenu.classList.add('active');
    } catch (error) {
        console.error("Error in resetAllGames:", error);
    }
}

// Matching Game Functions
function initializeMatchingGame() {
    try {
        const gameBoard = document.querySelector('.matching-game .game-board');
        if (!gameBoard) {
            console.error("Matching game board not found");
            return;
        }
        
        gameBoard.innerHTML = '';
        
        // Create shuffled array of cards
        let cards = [];
        matchingPairs.forEach(pair => {
            cards.push({ id: `a${pair.id}`, content: pair.front, pairId: pair.id });
            cards.push({ id: `b${pair.id}`, content: pair.back, pairId: pair.id });
        });
        
        // Shuffle cards
        cards = shuffleArray(cards);
        
        // Create card elements
        cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            cardElement.dataset.id = card.id;
            cardElement.dataset.pairId = card.pairId;
            
            cardElement.innerHTML = `
                <div class="card-front">${card.content}</div>
                <div class="card-back"></div>
            `;
            
            cardElement.addEventListener('click', flipCard);
            gameBoard.appendChild(cardElement);
        });
    } catch (error) {
        console.error("Error in initializeMatchingGame:", error);
    }
}

function flipCard() {
    try {
        // If already matched or already selected, do nothing
        if (this.classList.contains('matched') || selectedCards.includes(this) || selectedCards.length >= 2) {
            return;
        }
        
        // Flip the card
        this.classList.add('flipped');
        selectedCards.push(this);
        
        // If we have 2 cards flipped, check for match
        if (selectedCards.length === 2) {
            setTimeout(checkForMatch, 1000);
        }
    } catch (error) {
        console.error("Error in flipCard:", error);
    }
}

function checkForMatch() {
    try {
        const card1 = selectedCards[0];
        const card2 = selectedCards[1];
        
        if (!card1 || !card2) {
            console.error("Missing card in checkForMatch");
            selectedCards = [];
            return;
        }
        
        if (card1.dataset.pairId === card2.dataset.pairId) {
            // Match found
            card1.classList.add('matched');
            card2.classList.add('matched');
            
            matchedPairs++;
            matchingScore += 10;
            
            if (matchingScoreDisplay) {
                matchingScoreDisplay.textContent = matchingScore;
            }
            
            // Celebrate
            card1.classList.add('celebrate');
            card2.classList.add('celebrate');
            
            setTimeout(() => {
                card1.classList.remove('celebrate');
                card2.classList.remove('celebrate');
            }, 500);
            
            // Check if game is complete
            if (matchedPairs === matchingPairs.length / 2) {
                matchingScore += 20; // Bonus for completing
                if (matchingScoreDisplay) {
                    matchingScoreDisplay.textContent = matchingScore;
                }
                setTimeout(checkGameCompletion, 1000);
            }
        } else {
            // No match, flip back
            card1.classList.remove('flipped');
            card2.classList.remove('flipped');
        }
        
        // Reset selection
        selectedCards = [];
    } catch (error) {
        console.error("Error in checkForMatch:", error);
        selectedCards = [];
    }
}

function resetMatchingGame() {
    try {
        matchedPairs = 0;
        matchingScore = 0;
        selectedCards = [];
        
        if (matchingScoreDisplay) {
            matchingScoreDisplay.textContent = matchingScore;
        }
        
        const cards = document.querySelectorAll('.matching-game .card');
        cards.forEach(card => {
            card.classList.remove('flipped', 'matched');
        });
    } catch (error) {
        console.error("Error in resetMatchingGame:", error);
    }
}

// Word Search Functions
function initializeWordSearch() {
    try {
        const grid = document.querySelector('.word-game .word-grid');
        const wordList = document.querySelector('.word-game .word-list');
        
        if (!grid || !wordList) {
            console.error("Word search grid or word list not found");
            return;
        }
        
        // Clear previous grids
        grid.innerHTML = '';
        wordList.innerHTML = '';
        
        // Generate grid with random Hindi letters
        const gridSize = { rows: 8, cols: 8 };
        const gridLetters = Array(gridSize.rows).fill().map(() => Array(gridSize.cols).fill(''));
        
        // Fill with random letters first
        for (let i = 0; i < gridSize.rows; i++) {
            for (let j = 0; j < gridSize.cols; j++) {
                gridLetters[i][j] = getRandomHindiLetter();
            }
        }
        
        // Place words in the grid
        const directions = [
            [0, 1],  // Right
            [1, 0],  // Down
            [1, 1]   // Diagonal
        ];
        
        wordSearchWords.forEach(word => {
            let placed = false;
            let attempts = 0;
            
            while (!placed && attempts < 50) {
                attempts++;
                
                // Choose random direction
                const dirIndex = Math.floor(Math.random() * directions.length);
                const dir = directions[dirIndex];
                
                // Choose random starting position
                const startRow = Math.floor(Math.random() * (gridSize.rows - word.length * dir[0]));
                const startCol = Math.floor(Math.random() * (gridSize.cols - word.length * dir[1]));
                
                // Check if we can place the word
                let canPlace = true;
                for (let i = 0; i < word.length; i++) {
                    const row = startRow + i * dir[0];
                    const col = startCol + i * dir[1];
                    
                    // Fixed this condition - only place if cell is empty or matches the letter
                    if (gridLetters[row][col] !== word[i] && gridLetters[row][col] !== getRandomHindiLetter()) {
                        canPlace = false;
                        break;
                    }
                }
                
                // Place the word
                if (canPlace) {
                    for (let i = 0; i < word.length; i++) {
                        const row = startRow + i * dir[0];
                        const col = startCol + i * dir[1];
                        gridLetters[row][col] = word[i];
                    }
                    placed = true;
                }
            }
            
            // Force placement if not placed after max attempts
            if (!placed) {
                const dir = [0, 1]; // Right direction as fallback
                const startRow = Math.floor(Math.random() * gridSize.rows);
                const startCol = 0; // Start from leftmost position
                
                for (let i = 0; i < word.length && startCol + i < gridSize.cols; i++) {
                    gridLetters[startRow][startCol + i] = word[i];
                }
            }
        });
        
        // Create the grid in the UI
        for (let i = 0; i < gridSize.rows; i++) {
            for (let j = 0; j < gridSize.cols; j++) {
                const letter = document.createElement('div');
                letter.className = 'letter';
                letter.textContent = gridLetters[i][j];
                letter.dataset.row = i;
                letter.dataset.col = j;
                letter.addEventListener('click', selectLetter);
                grid.appendChild(letter);
            }
        }
        
        // Create the word list
        wordSearchWords.forEach(word => {
            const wordItem = document.createElement('div');
            wordItem.className = 'word-item';
            wordItem.textContent = word;
            wordItem.dataset.word = word;
            wordList.appendChild(wordItem);
        });
    } catch (error) {
        console.error("Error in initializeWordSearch:", error);
    }
}

function selectLetter() {
    try {
        // Toggle selection
        this.classList.toggle('selected');
        
        // If selected, add to current selection
        if (this.classList.contains('selected')) {
            currentWordSelection.push(this);
            
            // Check if we've formed a valid word
            const selectedWord = currentWordSelection.map(el => el.textContent).join('');
            
            if (wordSearchWords.includes(selectedWord) && !foundWords.includes(selectedWord)) {
                // Word found!
                foundWords.push(selectedWord);
                
                // Mark word as found in the list
                const wordItems = document.querySelectorAll('.word-item');
                wordItems.forEach(item => {
                    if (item.dataset.word === selectedWord) {
                        item.classList.add('word-found');
                    }
                });
                
                // Update score
                wordScore += selectedWord.length * 2;
                if (wordScoreDisplay) {
                    wordScoreDisplay.textContent = wordScore;
                }
                
                // Clear selection
                currentWordSelection.forEach(el => {
                    el.classList.remove('selected');
                    el.classList.add('celebrate');
                    setTimeout(() => el.classList.remove('celebrate'), 500);
                });
                currentWordSelection = [];
                
                // Check if all words found
                if (foundWords.length === wordSearchWords.length) {
                    wordScore += 30; // Bonus for finding all words
                    if (wordScoreDisplay) {
                        wordScoreDisplay.textContent = wordScore;
                    }
                    setTimeout(checkGameCompletion, 1000);
                }
            }
        } else {
            // If deselected, remove from current selection
            currentWordSelection = currentWordSelection.filter(el => el !== this);
        }
    } catch (error) {
        console.error("Error in selectLetter:", error);
    }
}

function resetWordSearch() {
    try {
        currentWordSelection = [];
        foundWords = [];
        wordScore = 0;
        
        if (wordScoreDisplay) {
            wordScoreDisplay.textContent = wordScore;
        }
    } catch (error) {
        console.error("Error in resetWordSearch:", error);
    }
}

// Quiz Game Functions
function displayQuestion() {
    try {
        const questionContainer = document.getElementById('current-question');
        const optionsContainer = document.getElementById('options-container');
        const progressBar = document.getElementById('quiz-progress');
        
        if (!questionContainer || !optionsContainer) {
            console.error("Quiz elements not found");
            return;
        }
        
        // If no more questions, end the game
        if (currentQuestionIndex >= quizQuestions.length) {
            // Quiz completed
            setTimeout(checkGameCompletion, 1000);
            return;
        }
        
        // Update progress bar
        if (progressBar) {
            const progress = ((currentQuestionIndex + 1) / quizQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        // Display current question
        const currentQuestion = quizQuestions[currentQuestionIndex];
        questionContainer.textContent = currentQuestion.question;
        
        // Clear previous options
        optionsContainer.innerHTML = '';
        
        // Add options
        currentQuestion.options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.className = 'quiz-option';
            optionElement.textContent = option;
            optionElement.dataset.index = index;
            optionElement.addEventListener('click', checkAnswer);
            optionsContainer.appendChild(optionElement);
        });
    } catch (error) {
        console.error("Error in displayQuestion:", error);
    }
}

function checkAnswer() {
    try {
        const selectedIndex = parseInt(this.dataset.index);
        const currentQuestion = quizQuestions[currentQuestionIndex];
        
        // Disable all options
        const options = document.querySelectorAll('.quiz-option');
        options.forEach(option => {
            option.removeEventListener('click', checkAnswer);
        });
        
        // Check if answer is correct
        if (selectedIndex === currentQuestion.answer) {
            // Correct answer
            this.classList.add('correct');
            this.classList.add('celebrate');
            
            quizScore += 10;
            if (quizScoreDisplay) {
                quizScoreDisplay.textContent = quizScore;
            }
        } else {
            // Wrong answer
            this.classList.add('incorrect');
            
            // Highlight correct answer
            if (options[currentQuestion.answer]) {
                options[currentQuestion.answer].classList.add('correct');
            }
        }
        
        // Move to next question after delay
        setTimeout(() => {
            currentQuestionIndex++;
            displayQuestion();
        }, 1500);
    } catch (error) {
        console.error("Error in checkAnswer:", error);
        // Move to next question as fallback
        currentQuestionIndex++;
        setTimeout(displayQuestion, 500);
    }
}

function resetQuiz() {
    try {
        currentQuestionIndex = 0;
        quizScore = 0;
        
        if (quizScoreDisplay) {
            quizScoreDisplay.textContent = quizScore;
        }
    } catch (error) {
        console.error("Error in resetQuiz:", error);
    }
}

// Utility Functions
function shuffleArray(array) {
    try {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    } catch (error) {
        console.error("Error in shuffleArray:", error);
        return array; // Return original array as fallback
    }
}

function getRandomHindiLetter() {
    try {
        const hindiLetters = "अआइईउऊएऐओऔकखगघचछजझटठडढणतथदधनपफबभमयरलवशषसह";
        return hindiLetters[Math.floor(Math.random() * hindiLetters.length)];
    } catch (error) {
        console.error("Error in getRandomHindiLetter:", error);
        return "अ"; // Return a default letter as fallback
    }
}

function createConfetti() {
    try {
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}%`;
            confetti.style.backgroundColor = getRandomColor();
            confetti.style.animationDelay = `${Math.random() * 3}s`;
            document.body.appendChild(confetti);
            
            // Remove after animation completes
            setTimeout(() => {
                confetti.remove();
            }, 3000);
        }
    } catch (error) {
        console.error("Error in createConfetti:", error);
    }
}

function getRandomColor() {
    try {
        const colors = ['#4CAF50', '#FFC107', '#2196F3', '#E91E63', '#9C27B0', '#FF5722'];
        return colors[Math.floor(Math.random() * colors.length)];
    } catch (error) {
        console.error("Error in getRandomColor:", error);
        return '#4CAF50'; // Return a default color as fallback
    }
}
